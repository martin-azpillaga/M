<!DOCTYPE html>
<html>
<head>

  <title>M blocks</title>

  <script src="blockly_compressed.js"></script>
  <script src="blocks_compressed.js"></script>
  <script src="blocks.js"></script>
  <script src="en.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    
    .full-height {
      height: 95%;
    }
  </style>

</head>

<body>

  <button type="button" onclick="save()">Save</button>
  <input type='file' onchange='onChooseFile(event, onFileLoad.bind(this, "contents"))' />

  <div id="blocklyDiv" class="full-height"></div>
  
  

  

  <xml xmlns="http://www.w3.org/1999/xhtml" id="toolbox" style="display: none;">
    <category name="Entities" colour="#5ba5a5">
      <block type="entity">
        <field name="NAME">name</field>
      </block>
      <block type="base">
        <field name="NAME">entity</field>
      </block>
      <block type="componentname">
        <field name="NAME">component name</field>
      </block>
    </category>
    <category name="Components" colour="#5b5ba5">
      <block type="tag">
        <field name="NAME">component</field>
      </block>
      <block type="real1">
        <field name="NAME">component</field>
        <field name="X">0</field>
      </block>
      <block type="real2">
        <field name="NAME">component</field>
        <field name="X">0</field>
        <field name="Y">0</field>
      </block>
      <block type="real3">
        <field name="NAME">component</field>
        <field name="X">0</field>
        <field name="Y">0</field>
        <field name="Z">0</field>
      </block>
      <block type="real4">
        <field name="NAME">component</field>
        <field name="X">0</field>
        <field name="Y">0</field>
        <field name="Z">0</field>
        <field name="W">0</field>
      </block>
      <block type="textcomponent">
        <field name="NAME">component</field>
        <field name="VALUE">text</field>
      </block>
      <block type="sprite">
        <field name="NAME">component</field>
        <field name="SPRITE">name</field>
      </block>
      <block type="audio">
        <field name="NAME">component</field>
        <field name="AUDIO">name</field>
      </block>
      <block type="mesh">
        <field name="NAME">component</field>
        <field name="MESH">name</field>
      </block>
      <block type="textcomponent">
        <field name="NAME">component</field>
        <field name="VALUE">text</field>
      </block>
      <block type="trigger">
        <field name="NAME">component</field>
        <field name="VALUE">START</field>
      </block>
      <block type="range">
        <field name="NAME">component</field>
        <field name="VALUE">LEFTX</field>
      </block>
      <block type="reference">
        <field name="NAME">component</field>
        <field name="ENTITY">name</field>
      </block>
      <block type="timer">
        <field name="NAME">component</field>
        <field name="SECONDS">0</field>
      </block>
      <block type="enumeration">
        <field name="NAME">component</field>
      </block>
      <block type="enumeration_value">
        <field name="NAME">name</field>
      </block>
      <block type="sensor">
        <field name="NAME">component</field>
      </block>
    </category>
    <sep></sep>
    <category name="Flow" colour="#5ba55b">
      <block type="system">
        <field name="NAME">name</field>
      </block>
      <block type="loop">
        <field name="GROUP">name</field>
      </block>
      <block type="if"></block>
      <block type="while"></block>
    </category>
    <category name="Commands" colour="#5b5ba5">
      <block type="declaration">
        <field name="NAME">name</field>
      </block>
      <block type="variable_assignment">
        <field name="assignmentType">SET</field>
        <field name="NAME">variable</field>
      </block>
      <block type="component_assignment">
        <field name="assignmentType">SET</field>
        <field name="COMPONENT">component</field>
        <field name="ENTITY">entity</field>
      </block>
      <block type="subrutine_call">
        <field name="SUBRUTINE">subrutine</field>
      </block>
      <block type="break"></block>
    </category>
    <category name="Constraints" colour="#a55b93">
      <block type="tagged">
        <field name="negated">TRUE</field>
        <field name="NAME">name</field>
      </block>
      <block type="timeout">
        <field name="NAME">name</field>
      </block>
      <block type="triggered">
        <field name="NAME">name</field>
      </block>
      <block type="detection">
        <field name="NAME">ENTER</field>
      </block>
      <block type="mouse">
        <field name="NAME">DOWN</field>
      </block>
    </category>
    <sep></sep>
    <category name="Access" colour="#a5a55b">
      <block type="pop">
        <field name="VARIABLE">variable</field>
      </block>
      <block type="vertical_pop">
        <field name="VARIABLE">variable</field>
      </block>
      <block type="access">
        <field name="COMPONENT">component</field>
        <field name="ENTITY">entity</field>
      </block>
      <block type="vertical_access">
        <field name="COMPONENT">component</field>
        <field name="ENTITY">entity</field>
      </block>
      <block type="call">
        <field name="FUNCTION">function</field>
      </block>
      <block type="vertical_call">
        <field name="FUNCTION">function</field>
      </block>
    </category>
    <category name="Transformation" colour="#a5805b">
      <block type="math_arithmetic">
        <field name="OP">ADD</field>
        <value name="A">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
        <value name="B">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
      </block>
      <block type="math_trig">
        <field name="OP">SIN</field>
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">45</field>
          </shadow>
        </value>
      </block>
      <block type="math_single">
        <field name="OP">ROOT</field>
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">9</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="logic_compare">
        <field name="OP">EQ</field>
      </block>
      <block type="logic_operation">
        <field name="OP">AND</field>
      </block>
      <block type="logic_negate"></block>
    </category>
  </xml>

  <script>
    function onFileLoad(elementId, event) 
    {
        var xml = Blockly.Xml.textToDom(event.target.result);
        Blockly.Xml.domToWorkspace(xml, workspace);
    }

    function onChooseFile(event, onLoadFileHandler) {
        if (typeof window.FileReader !== 'function')
            throw ("The file API isn't supported on this browser.");
        let input = event.target;
        if (!input)
            throw ("The browser does not properly implement the event object");
        if (!input.files)
            throw ("This browser does not support the `files` property of the file input.");
        if (!input.files[0])
            return undefined;
        let file = input.files[0];
        let fr = new FileReader();
        fr.onload = onLoadFileHandler;
        fr.readAsText(file);
    }
  </script>

  <script>
      var workspace = Blockly.inject('blocklyDiv', {toolbox: document.getElementById('toolbox')});
      function myUpdateFunction(event) 
      {
        //alert("I am an alert box!");
      }
      function load()
      {
        alert("Alerta")
      }
      function save()
      {
        var xml = Blockly.Xml.workspaceToDom(workspace);
        var xml_text = Blockly.Xml.domToText(xml);
        var blob = new Blob([xml_text],{type: "text/xml"});
        var url = URL.createObjectURL(blob),
					div = document.createElement("div"),
					anch = document.createElement("a");
 
				document.body.appendChild(div);
				div.appendChild(anch);
 
				anch.innerHTML = "&nbsp;";
				div.style.width = "0";
				div.style.height = "0";
				anch.href = url;
				anch.download = "workspace";
				
				var ev = new MouseEvent("click",{});
				anch.dispatchEvent(ev);
				document.body.removeChild(div);

      }
      workspace.addChangeListener(myUpdateFunction);
  </script>

</body>
</html>
