<!DOCTYPE html>
<html style="height: 100%;">

<head>

  <title>M editor</title>

  <meta charset="utf-8"/>
  <script src="https://blockly-demo.appspot.com/static/blockly_compressed.js"></script>

</head>

<body style="margin: 0; height: 100%;">

  <header style="height: 5%; background-color: black;">
    <select style="float: left; cursor: pointer; width: 7%;">
      <option value='M'>M</option>
      <option value='English'>English</option>
    </select>
    <button id="save-button" style="float: right; cursor: pointer;">Save</button>
    <button id="load-button" style="float: right; cursor: pointer;">Load</button>
  </header>

  <section style="height: 95%;">
    <div id="blocklyDiv" style="height: 100%; display: inline-block;width: 100%;"></div>
  </section>

  

  <input id="uploaded-input" type="file" style="display: none;" />

  <script>
  Blockly.Blocks['entity'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldImage("https://www.gstatic.com/codesite/ph/images/star_on.gif", 15, 15, "entity"))
        .appendField(new Blockly.FieldTextInput("name"), "name");
    this.appendStatementInput("components")
        .setCheck(["tag", "valued"]);
    this.setInputsInline(true);
    this.setPreviousStatement(true, "entity");
    this.setNextStatement(true, "entity");
    this.setColour(230);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['tagcomponent'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldTextInput("name"), "name");
    this.setInputsInline(true);
    this.setPreviousStatement(true, "tag");
    this.setNextStatement(true, ["tag", "valued"]);
    this.setColour(230);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['valuedcomponent'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldTextInput("name"), "name");
    this.appendValueInput("value")
        .setCheck("value");
    this.setInputsInline(true);
    this.setPreviousStatement(true, "valued");
    this.setNextStatement(true, ["tag", "valued"]);
    this.setColour(230);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['system'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldImage("https://www.gstatic.com/codesite/ph/images/star_on.gif", 15, 15, "entity"))
        .appendField(new Blockly.FieldTextInput("name"), "name");
    this.appendStatementInput("commands")
        .setCheck("command");
    this.setInputsInline(true);
    this.setColour(105);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['loop'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldImage("https://www.gstatic.com/codesite/ph/images/star_on.gif", 15, 15, "entity"))
        .appendField(new Blockly.FieldTextInput("entity"), "entity");
    this.appendStatementInput("constraints")
        .setCheck("tag");
    this.appendStatementInput("commands")
        .setCheck("command");
    this.setInputsInline(true);
    this.setPreviousStatement(true, "command");
    this.setNextStatement(true, "command");
    this.setColour(105);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['branch'] = {
  init: function() {
    this.appendValueInput("expression")
        .setCheck(["access", "expression"])
        .appendField(new Blockly.FieldImage("https://www.gstatic.com/codesite/ph/images/star_on.gif", 15, 15, "entity"));
    this.appendStatementInput("commands")
        .setCheck("command");
    this.setInputsInline(true);
    this.setPreviousStatement(true, "command");
    this.setNextStatement(true, "command");
    this.setColour(105);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['assignment'] = {
  init: function() {
    this.appendValueInput("access")
        .setCheck("access");
    this.appendDummyInput()
        .appendField(new Blockly.FieldDropdown([["=","set"], ["+=","increase"], ["-=","decrease"], ["*=","multiply"], ["/=","divide"]]), "type");
    this.appendValueInput("expression")
        .setCheck(["access", "expression"]);
    this.setInputsInline(true);
    this.setPreviousStatement(true, "command");
    this.setNextStatement(true, "command");
    this.setColour(105);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['access3'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldTextInput("a"), "a")
        .appendField(".")
        .appendField(new Blockly.FieldTextInput("b"), "b")
        .appendField(".")
        .appendField(new Blockly.FieldTextInput("c"), "c");
    this.setInputsInline(true);
    this.setOutput(true, "access");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['access2'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldTextInput("a"), "a")
        .appendField(".")
        .appendField(new Blockly.FieldTextInput("b"), "b");
    this.setInputsInline(true);
    this.setOutput(true, "access");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['binaryexpression'] = {
  init: function() {
    this.appendValueInput("left")
        .setCheck(["access", "expression"]);
    this.appendDummyInput()
        .appendField(new Blockly.FieldDropdown([["+","plus"], ["-","minus"], ["*","times"], ["/","divide"], ["&&","and"], ["||","or"], ["<","less"], ["<=","lessOrEqual"], ["=","equal"], [">=","greaterOrEqual"], [">","greater"], ["!=","notEqual"]]), "operation");
    this.appendValueInput("right")
        .setCheck(["access", "expression"]);
    this.setInputsInline(true);
    this.setOutput(true, "expression");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['unaryexpression'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldDropdown([["!","not"], ["~","bitwiseNot"], ["++","increment"], ["--","decrement"]]), "operation");
    this.appendValueInput("expression")
        .setCheck(["access", "expression"]);
    this.setInputsInline(true);
    this.setOutput(true, "expression");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['brackets'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("(");
    this.appendValueInput("expression")
        .setCheck(["access", "expression"]);
    this.appendDummyInput()
        .appendField(")");
    this.setInputsInline(true);
    this.setOutput(true, "expression");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['real1value'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldNumber(0), "x");
    this.setInputsInline(true);
    this.setOutput(true, "value");
    this.setColour(230);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['real4value'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldNumber(0), "x")
        .appendField(new Blockly.FieldNumber(0), "y")
        .appendField(new Blockly.FieldNumber(0), "z")
        .appendField(new Blockly.FieldNumber(0), "w");
    this.setInputsInline(true);
    this.setOutput(true, "value");
    this.setColour(230);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['real3value'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldNumber(0), "x")
        .appendField(new Blockly.FieldNumber(0), "y")
        .appendField(new Blockly.FieldNumber(0), "z");
    this.setInputsInline(true);
    this.setOutput(true, "value");
    this.setColour(230);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['real2value'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldNumber(0), "x")
        .appendField(new Blockly.FieldNumber(0), "y");
    this.setInputsInline(true);
    this.setOutput(true, "value");
    this.setColour(230);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['wordvalue'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldTextInput("asset name"), "name");
    this.setInputsInline(true);
    this.setOutput(true, "value");
    this.setColour(230);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['access1'] = {
  init: function() {
    this.appendDummyInput()
        .appendField(new Blockly.FieldTextInput("a"), "a");
    this.setInputsInline(true);
    this.setOutput(true, "access");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['add'] = {
  init: function() {
    this.appendValueInput("component")
        .setCheck(null)
        .appendField("add");
    this.appendValueInput("entity")
        .setCheck(null)
        .appendField("to");
    this.setInputsInline(true);
    this.setOutput(true, "expression");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['remove'] = {
  init: function() {
    this.appendValueInput("component")
        .setCheck(null)
        .appendField("remove");
    this.appendValueInput("entity")
        .setCheck(null)
        .appendField("from");
    this.setInputsInline(true);
    this.setOutput(true, "expression");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['join3'] = {
  init: function() {
    this.appendValueInput("x")
        .setCheck(null)
        .appendField("join");
    this.appendValueInput("y")
        .setCheck(null)
        .appendField(",");
    this.appendValueInput("z")
        .setCheck(null)
        .appendField(",");
    this.setInputsInline(true);
    this.setOutput(true, "expression");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['join2'] = {
  init: function() {
    this.appendValueInput("x")
        .setCheck(null)
        .appendField("join");
    this.appendValueInput("y")
        .setCheck(null)
        .appendField(",");
    this.setInputsInline(true);
    this.setOutput(true, "expression");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['join4'] = {
  init: function() {
    this.appendValueInput("x")
        .setCheck(null)
        .appendField("join");
    this.appendValueInput("y")
        .setCheck(null)
        .appendField(",");
    this.appendValueInput("z")
        .setCheck(null)
        .appendField(",");
    this.appendValueInput("w")
        .setCheck(null)
        .appendField(",");
    this.setInputsInline(true);
    this.setOutput(true, "expression");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['random'] = {
  init: function() {
    this.appendValueInput("expression")
        .setCheck(null)
        .appendField("random");
    this.setInputsInline(true);
    this.setOutput(true, "expression");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['create'] = {
  init: function() {
    this.appendValueInput("expression")
        .setCheck(null)
        .appendField("create");
    this.setInputsInline(true);
    this.setOutput(true, "expression");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['destroy'] = {
  init: function() {
    this.appendValueInput("expression")
        .setCheck(null)
        .appendField("destroy");
    this.setInputsInline(true);
    this.setOutput(true, "expression");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['mathfunction'] = {
  init: function() {
    this.appendValueInput("expression")
        .setCheck(null)
        .setAlign(Blockly.ALIGN_CENTRE)
        .appendField(new Blockly.FieldDropdown([["sin","sin"], ["cos","cos"], ["ta","tan"]]), "name");
    this.setInputsInline(true);
    this.setOutput(true, "expression");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['converttocommand'] = {
  init: function() {
    this.appendValueInput("value")
        .setCheck(["access", "expression"])
        .appendField("call");
    this.setInputsInline(true);
    this.setPreviousStatement(true, "command");
    this.setNextStatement(true, "command");
    this.setColour(105);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

Blockly.Blocks['has'] = {
  init: function() {
    this.appendValueInput("entity")
        .setCheck(null)
        .appendField("entity");
    this.appendValueInput("component")
        .setCheck(null)
        .appendField("has");
    this.setInputsInline(true);
    this.setOutput(true, "access");
    this.setColour(150);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};
  
var workspace = Blockly.inject('blocklyDiv', {toolbox: 
`<xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
    <category name="Entities" colour="#5b67a5">
      <block type="entity">
        <field name="name">name</field>
      </block>
      <block type="tagcomponent">
        <field name="name">name</field>
      </block>
      <block type="valuedcomponent">
        <field name="name">name</field>
      </block>
      <block type="real1value">
        <field name="x">0</field>
      </block>
      <block type="real2value">
        <field name="x">0</field>
        <field name="y">0</field>
      </block>
      <block type="real3value">
        <field name="x">0</field>
        <field name="y">0</field>
        <field name="z">0</field>
      </block>
      <block type="real4value">
        <field name="x">0</field>
        <field name="y">0</field>
        <field name="z">0</field>
        <field name="w">0</field>
      </block>
      <block type="wordvalue">
        <field name="name">asset name</field>
      </block>
    </category>
    <category name="Systems" colour="#5ba55b">
      <block type="system">
        <field name="name">name</field>
      </block>
      <block type="loop">
        <field name="entity">entity</field>
      </block>
      <block type="branch"></block>
      <block type="assignment">
        <field name="type">set</field>
      </block>
      <block type="converttocommand"></block>
    </category>
    <category name="Expressions" colour="#5ba58c">
      <block type="access1">
        <field name="a">a</field>
      </block>
      <block type="access2">
        <field name="a">a</field>
        <field name="b">b</field>
      </block>
      <block type="access3">
        <field name="a">a</field>
        <field name="b">b</field>
        <field name="c">c</field>
      </block>
      <block type="binaryexpression">
        <field name="operation">plus</field>
      </block>
      <block type="unaryexpression">
        <field name="operation">not</field>
      </block>
      <block type="brackets" />
    </category>
    <category name="Calls" colour="#745ba5">
      <block type="add"></block>
      <block type="remove"></block>
      <block type="join2"></block>
      <block type="join3"></block>
      <block type="join4"></block>
      <block type="random"></block>
      <block type="create"></block>
      <block type="destroy"></block>
      <block type="mathfunction">
        <field name="name">sin</field>
      </block>
      <block type="has"></block>
    </category>
  </xml>`, zoom: {controls: true, wheel: true}});
document.getElementsByClassName('blocklySvg')[0].style.backgroundColor = '#000000';
console.log(Blockly.Blocks);
console.log(Blockly);
document.getElementById("load-button").addEventListener("click", function()
{
    document.getElementById("uploaded-input").click();
});

document.getElementById("uploaded-input").addEventListener("change", function()
{
    var file = document.getElementById("uploaded-input").files[0];
    var fr = new FileReader();
    fr.onload = function(e)
    {
        var xml = Blockly.Xml.textToDom(e.target.result);
        Blockly.Xml.domToWorkspace(xml, workspace);
    };
    fr.readAsText(file);
});

document.getElementById("save-button").addEventListener("click", function()
{ 
    var xml = Blockly.Xml.workspaceToDom(workspace);
    var xml_text = Blockly.Xml.domToPrettyText (xml);

    download(xml_text, "blocks", "text/xml");
});

function download(text, name, type)
{
    var blob = new Blob([text],{type: type});
    var url = URL.createObjectURL(blob);
    var div = document.createElement("div")
    var anch = document.createElement("a");

    document.body.appendChild(div);
    div.appendChild(anch);

    anch.innerHTML = "&nbsp;";
    anch.href = url;
    anch.download = name;
        
    var ev = new MouseEvent("click",{});
    anch.dispatchEvent(ev);
    document.body.removeChild(div);
}</script>

</body>

</html>